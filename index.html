<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نظام إدارة المشاريع</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
:root{--pri:#0C4A6E;--pri2:#0284C7;--acc:#F59E0B;--ok:#059669;--err:#DC2626;--warn:#F59E0B;--bg:#F1F5F9;--card:#fff;--txt:#1E293B;--txt2:#64748B;--brd:#E2E8F0;--brd2:#F1F5F9}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Tajawal',sans-serif;background:var(--bg);color:var(--txt)}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:3px}
input,select,textarea,button{font-family:'Tajawal',sans-serif}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

/* === LOGIN === */
#loginPage{min-height:100vh;display:flex;background:linear-gradient(135deg,#0C4A6E,#0369A1 40%,#0284C7 70%,#0EA5E9);position:relative;overflow:hidden}
.lbg{position:absolute;border-radius:50%;pointer-events:none}
.lbg1{top:8%;right:3%;width:400px;height:400px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06)}
.lbg2{bottom:10%;left:8%;width:300px;height:300px;background:rgba(255,255,255,.04)}
.lbg3{top:45%;right:35%;width:200px;height:200px;background:rgba(245,158,11,.08)}
.l-brand{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:40px;z-index:1;text-align:center}
.l-logo{width:80px;height:80px;border-radius:22px;background:rgba(255,255,255,.14);backdrop-filter:blur(16px);display:flex;align-items:center;justify-content:center;margin:0 auto 24px;border:1px solid rgba(255,255,255,.18)}
.l-brand h1{font-size:34px;font-weight:900;color:#fff}
.l-brand p{font-size:16px;color:rgba(255,255,255,.7);margin-top:12px;line-height:1.8}
.l-feats{display:flex;gap:36px;margin-top:40px;justify-content:center}
.l-feat{text-align:center}.l-feat-i{width:48px;height:48px;border-radius:14px;background:rgba(255,255,255,.09);display:flex;align-items:center;justify-content:center;margin:0 auto 8px;border:1px solid rgba(255,255,255,.12)}
.l-feat span{font-size:11px;color:rgba(255,255,255,.6)}
.l-form{width:480px;display:flex;align-items:center;justify-content:center;padding:40px;z-index:1}
.l-card{width:100%;max-width:400px;background:rgba(255,255,255,.96);backdrop-filter:blur(30px);border-radius:24px;padding:40px 36px;box-shadow:0 24px 64px rgba(0,0,0,.18)}
.l-card h2{font-size:22px;font-weight:800;color:#0F172A;text-align:center;margin-bottom:6px}
.l-card .sub{font-size:13px;color:var(--txt2);text-align:center;margin-bottom:28px}
.fg{margin-bottom:18px}.fg label{display:block;font-size:12px;font-weight:600;color:#374151;margin-bottom:6px}
.fi{position:relative}.fi input{width:100%;padding:12px 40px 12px 14px;border-radius:12px;border:2px solid var(--brd);font-size:13px;outline:none;background:#F8FAFC;transition:.2s}
.fi input:focus{border-color:var(--pri2);background:#fff}
.fi svg{position:absolute;right:12px;top:50%;transform:translateY(-50%);pointer-events:none;color:#94A3B8}
.l-err{background:#FEE2E2;color:var(--err);padding:10px 14px;border-radius:10px;font-size:12px;margin-bottom:14px;display:none;text-align:center}
.l-err.show{display:block}
.btn-auth{width:100%;padding:14px;border-radius:12px;border:none;font-size:15px;font-weight:700;background:linear-gradient(135deg,var(--pri),var(--pri2));color:#fff;cursor:pointer;transition:.2s;box-shadow:0 4px 16px rgba(12,74,110,.3)}
.btn-auth:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(12,74,110,.4)}
.btn-auth:disabled{background:#94A3B8;cursor:not-allowed;transform:none;box-shadow:none}
.spinner{display:inline-block;width:18px;height:18px;border:2.5px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-left:8px}
.l-toggle{text-align:center;margin-top:18px;font-size:12px;color:var(--txt2)}
.l-toggle a{color:var(--pri2);font-weight:600;cursor:pointer;text-decoration:underline}
.l-foot{text-align:center;margin-top:22px;font-size:11px;color:#94A3B8}

/* === APP === */
#appPage{display:none}
.sidebar{width:250px;min-height:100vh;background:linear-gradient(180deg,#0C4A6E,#082F49);position:fixed;right:0;top:0;z-index:100;display:flex;flex-direction:column;transition:.25s}
.sidebar.mini{width:72px}
.s-hd{padding:20px 18px;border-bottom:1px solid rgba(255,255,255,.07);display:flex;align-items:center;gap:12px}
.sidebar.mini .s-hd{justify-content:center;padding:20px 10px}
.s-lg{width:38px;height:38px;border-radius:10px;background:rgba(245,158,11,.2);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.s-nm{font-size:15px;font-weight:800;color:#fff;white-space:nowrap}
.s-v{font-size:9px;color:rgba(255,255,255,.45)}
.sidebar.mini .s-tx{display:none}
.s-nv{flex:1;padding:14px 8px;display:flex;flex-direction:column;gap:3px}
.nv{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;border:none;cursor:pointer;background:transparent;width:100%;transition:.15s;color:rgba(255,255,255,.55)}
.sidebar.mini .nv{justify-content:center;padding:12px 0}
.nv:hover{background:rgba(255,255,255,.07)}
.nv.on{background:rgba(245,158,11,.14);color:var(--acc)}
.nv span{font-size:13px;font-weight:500;white-space:nowrap;color:inherit}
.nv.on span{font-weight:700}
.sidebar.mini .nv span,.sidebar.mini .nv-d{display:none}
.nv-d{width:5px;height:5px;border-radius:50%;background:var(--acc);margin-right:auto}
.s-ft{padding:12px 8px;border-top:1px solid rgba(255,255,255,.07)}
.s-ft button{width:100%;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,.05);cursor:pointer;color:rgba(255,255,255,.5);display:flex;align-items:center;justify-content:center}
.s-ft button:hover{background:rgba(255,255,255,.1)}

.mn{margin-right:250px;transition:.25s;min-height:100vh}
.mn.mini{margin-right:72px}
.hdr{height:64px;background:#fff;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between;padding:0 24px;position:sticky;top:0;z-index:50}
.hdr h1{font-size:20px;font-weight:800;color:#0F172A}
.h-r{display:flex;align-items:center;gap:14px}
.h-s{position:relative}.h-s input{width:200px;padding:9px 34px 9px 14px;border-radius:10px;border:1px solid var(--brd);font-size:12px;outline:none;background:#F8FAFC}
.h-s svg{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:#94A3B8;pointer-events:none}
.h-u{display:flex;align-items:center;gap:10px;padding-right:14px;border-right:1px solid var(--brd)}
.h-av{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,var(--pri),var(--pri2));display:flex;align-items:center;justify-content:center;color:#fff;font-size:15px;font-weight:700}
.h-nm{font-size:12px;font-weight:700;color:#0F172A}.h-rl{font-size:10px;color:#94A3B8}
.h-lo{width:38px;height:38px;border-radius:10px;border:1px solid #FEE2E2;background:#FEF2F2;display:flex;align-items:center;justify-content:center;cursor:pointer}
.pg{padding:24px}

/* === COMPONENTS === */
.row{display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap}
.col{flex:1;min-width:0}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:16px}

.card{background:#fff;border-radius:14px;padding:20px;border:1px solid var(--brd);animation:fadeUp .3s ease}
.card-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.card-t{font-size:15px;font-weight:700;color:#0F172A}

/* Stat */
.st{background:#fff;border-radius:14px;padding:20px 18px;border:1px solid var(--brd);position:relative;overflow:hidden;transition:.2s}
.st:hover{box-shadow:0 4px 12px rgba(0,0,0,.05)}
.st-i{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:14px}
.st-v{font-size:26px;font-weight:800;color:#0F172A}
.st-l{font-size:12px;color:var(--txt2);margin-top:3px}

/* Progress */
.prg{display:flex;align-items:center;gap:8px;width:100%}
.prg-t{flex:1;height:7px;background:#E2E8F0;border-radius:7px;overflow:hidden}
.prg-f{height:100%;border-radius:7px;transition:width .8s ease}
.prg-v{font-size:11px;font-weight:700;min-width:34px;text-align:left}

/* Badge */
.bg{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:16px;font-size:11px;font-weight:600}
.bg-d{width:6px;height:6px;border-radius:50%}
.bg-act{background:#DBEAFE;color:#1D4ED8}.bg-act .bg-d{background:#3B82F6}
.bg-ok{background:#D1FAE5;color:#047857}.bg-ok .bg-d{background:#10B981}
.bg-err{background:#FEE2E2;color:#B91C1C}.bg-err .bg-d{background:#EF4444}
.bg-new{background:#FEF3C7;color:#92400E}.bg-new .bg-d{background:#F59E0B}
.pr-h{background:#FEE2E2;color:var(--err);padding:2px 8px;border-radius:5px;font-size:10px;font-weight:600}
.pr-m{background:#FEF3C7;color:#D97706;padding:2px 8px;border-radius:5px;font-size:10px;font-weight:600}
.pr-l{background:#D1FAE5;color:var(--ok);padding:2px 8px;border-radius:5px;font-size:10px;font-weight:600}

/* Table */
table.tb{width:100%;border-collapse:collapse}
.tb th{padding:12px 14px;font-size:11px;font-weight:700;color:var(--txt2);text-align:right;background:#F8FAFC;border-bottom:1px solid var(--brd)}
.tb td{padding:14px;font-size:12px;border-bottom:1px solid var(--brd2)}
.tb tr:hover td{background:#FAFBFC}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:7px;padding:9px 18px;border-radius:10px;border:none;font-size:13px;font-weight:700;cursor:pointer;transition:.15s}
.btn-p{background:linear-gradient(135deg,var(--pri),var(--pri2));color:#fff;box-shadow:0 3px 12px rgba(12,74,110,.25)}
.btn-p:hover{transform:translateY(-1px);box-shadow:0 5px 16px rgba(12,74,110,.35)}
.btn-o{background:#fff;border:1px solid var(--brd);color:var(--txt2)}
.btn-d{background:none;border:1px solid #FEE2E2;color:var(--err);padding:6px 10px;border-radius:8px;font-size:11px}
.btn-d:hover{background:#FEF2F2}

/* Empty */
.emp{text-align:center;padding:50px 20px}
.emp-i{width:70px;height:70px;border-radius:18px;background:var(--bg);display:flex;align-items:center;justify-content:center;margin:0 auto 16px}
.emp-t{font-size:17px;font-weight:700;color:#0F172A;margin-bottom:6px}
.emp-d{font-size:13px;color:#94A3B8;margin-bottom:20px}

/* Project card */
.pc{background:#fff;border-radius:14px;padding:20px;border:1px solid var(--brd);transition:.2s;cursor:default}
.pc:hover{box-shadow:0 6px 24px rgba(0,0,0,.06)}
.pc h3{font-size:14px;font-weight:700;color:#0F172A;margin:12px 0 6px;line-height:1.5}
.pc-m{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px;padding-top:12px;border-top:1px solid var(--brd2)}
.pc-mi{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--txt2)}

/* Team card */
.tc{background:#fff;border-radius:14px;padding:24px;border:1px solid var(--brd);text-align:center;transition:.2s}
.tc:hover{box-shadow:0 6px 24px rgba(0,0,0,.06)}
.tc-av{width:64px;height:64px;border-radius:18px;background:linear-gradient(135deg,var(--pri),var(--pri2));display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:26px;font-weight:800;color:#fff;box-shadow:0 6px 20px rgba(12,74,110,.2)}

/* Calendar */
.cg{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.c-hd{padding:10px;text-align:center;font-size:11px;font-weight:700;color:var(--txt2);background:#F8FAFC;border-radius:6px}
.c-d{padding:8px;min-height:70px;border-radius:6px;border:1px solid var(--brd2);background:#fff;font-size:12px;color:var(--txt)}
.c-d.tdy{background:#EFF6FF}
.c-dn{font-weight:500}.c-dn.tdy{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:var(--pri2);color:#fff;font-weight:800}

/* Modal */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:500;display:none;align-items:center;justify-content:center}
.modal-bg.open{display:flex}
.modal{background:#fff;border-radius:18px;padding:28px;width:460px;max-width:92vw;max-height:82vh;overflow-y:auto;animation:fadeUp .2s ease}
.modal h3{font-size:17px;font-weight:700;color:#0F172A;margin-bottom:20px}
.modal .fg input,.modal .fg select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--brd);font-size:12px;outline:none;background:#F8FAFC}
.modal .fg input:focus,.modal .fg select:focus{border-color:var(--pri2)}
.m-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.m-row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.m-btns{display:flex;gap:8px;margin-top:20px}
.btn-cancel{padding:9px 18px;border-radius:10px;border:1px solid var(--brd);background:#fff;font-size:13px;font-weight:600;color:var(--txt2);cursor:pointer}

/* Loading */
.ld{position:fixed;inset:0;background:rgba(255,255,255,.85);z-index:600;display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px}
.ld.on{display:flex}
.ld-sp{width:36px;height:36px;border:3px solid #E2E8F0;border-top-color:var(--pri2);border-radius:50%;animation:spin .7s linear infinite}

.hide{display:none!important}

/* Report card */
.rpc{background:#fff;border-radius:14px;padding:20px;border:1px solid var(--brd);transition:.2s;cursor:pointer}
.rpc:hover{box-shadow:0 6px 24px rgba(0,0,0,.06)}
.rpc-i{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:12px}

/* Settings */
.s-inp{width:100%;padding:10px 14px;border-radius:10px;border:1px solid var(--brd);font-size:13px;background:#F8FAFC;outline:none}
.s-inp:focus{border-color:var(--pri2)}
.tgl{width:44px;height:24px;border-radius:12px;position:relative;cursor:pointer;transition:.2s}
.tgl.y{background:var(--pri2)}.tgl.n{background:#E2E8F0}
.tgl-k{width:18px;height:18px;border-radius:50%;background:#fff;position:absolute;top:3px;box-shadow:0 1px 3px rgba(0,0,0,.12);transition:.2s}
.tgl.y .tgl-k{right:3px}.tgl.n .tgl-k{right:23px}
</style>
</head>
<body>

<div class="ld" id="loader"><div class="ld-sp"></div><span style="font-size:13px;color:var(--txt2)">جارٍ التحميل...</span></div>

<!-- ======= LOGIN ======= -->
<div id="loginPage">
  <div class="lbg lbg1"></div><div class="lbg lbg2"></div><div class="lbg lbg3"></div>
  <div class="l-brand">
    <div>
      <div class="l-logo"><svg width="36" height="36" fill="none" stroke="#F59E0B" stroke-width="2" viewBox="0 0 24 24"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg></div>
      <h1>نظام إدارة المشاريع</h1>
      <p>منصة متكاملة لإدارة ومتابعة المشاريع بكفاءة عالية</p>
      <div class="l-feats">
        <div class="l-feat"><div class="l-feat-i"><svg width="20" height="20" fill="none" stroke="rgba(255,255,255,.75)" stroke-width="2" viewBox="0 0 24 24"><path d="M2 20a2 2 0 002 2h16a2 2 0 002-2V8l-7 5V8l-7 5V4a2 2 0 00-2-2H4a2 2 0 00-2 2Z"/></svg></div><span>المشاريع</span></div>
        <div class="l-feat"><div class="l-feat-i"><svg width="20" height="20" fill="none" stroke="rgba(255,255,255,.75)" stroke-width="2" viewBox="0 0 24 24"><path d="M11 18H3"/><path d="m15 18 2 2 4-4"/><path d="M16 12H3"/><path d="M16 6H3"/></svg></div><span>المهام</span></div>
        <div class="l-feat"><div class="l-feat-i"><svg width="20" height="20" fill="none" stroke="rgba(255,255,255,.75)" stroke-width="2" viewBox="0 0 24 24"><path d="M3 3v16a2 2 0 002 2h16"/><path d="M7 16h8"/><path d="M7 11h12"/><path d="M7 6h3"/></svg></div><span>التقارير</span></div>
      </div>
    </div>
  </div>
  <div class="l-form">
    <div class="l-card">
      <h2 id="aTitle">تسجيل الدخول</h2>
      <p class="sub" id="aSub">أدخل بياناتك للوصول إلى لوحة التحكم</p>
      <div class="l-err" id="aErr"></div>
      <div class="fg hide" id="fName"><label>الاسم الكامل</label><div class="fi"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 00-4-4H9a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><input id="iName" placeholder="الاسم الكامل"></div></div>
      <div class="fg"><label>البريد الإلكتروني</label><div class="fi"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 01-2.06 0L2 7"/></svg><input type="email" id="iEmail" placeholder="example@domain.com"></div></div>
      <div class="fg"><label>كلمة المرور</label><div class="fi"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="11" x="3" y="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg><input type="password" id="iPass" placeholder="••••••••"></div></div>
      <button class="btn-auth" id="aBtn" type="button">تسجيل الدخول</button>
      <div class="l-toggle" id="aTog">ليس لديك حساب؟ <a id="aTog2">إنشاء حساب جديد</a></div>
      <div class="l-foot">© 2025 نظام إدارة المشاريع - جميع الحقوق محفوظة</div>
    </div>
  </div>
</div>

<!-- ======= APP ======= -->
<div id="appPage">
  <div class="sidebar" id="sb">
    <div class="s-hd"><div class="s-lg"><svg width="20" height="20" fill="none" stroke="#F59E0B" stroke-width="2" viewBox="0 0 24 24"><path d="m12.83 2.18a2 2 0 00-1.66 0L2.6 6.08a1 1 0 000 1.83l8.58 3.91a2 2 0 001.66 0l8.58-3.9a1 1 0 000-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 01-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 01-1.66 0L2 12.65"/></svg></div><div class="s-tx"><div class="s-nm">إدارة المشاريع</div><div class="s-v">PMS v2.0</div></div></div>
    <nav class="s-nv" id="sNav"></nav>
    <div class="s-ft"><button id="togSb"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="m9 18 6-6-6-6"/></svg></button></div>
  </div>
  <div class="mn" id="mn">
    <header class="hdr">
      <h1 id="pgT">لوحة التحكم</h1>
      <div class="h-r">
        <div class="h-s"><svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg><input placeholder="بحث..."></div>
        <div class="h-u"><div style="text-align:left"><div class="h-nm" id="hNm">المستخدم</div><div class="h-rl">مدير النظام</div></div><div class="h-av" id="hAv">م</div></div>
        <button class="h-lo" id="logoutBtn" title="خروج"><svg width="16" height="16" fill="none" stroke="#DC2626" stroke-width="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg></button>
      </div>
    </header>
    <div class="pg" id="pgC"></div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-bg" id="mBg"><div class="modal" id="mC"></div></div>

<script>
// ============ SUPABASE ============
const SB_URL = 'https://iaexxprgkjvstviejgot.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhZXh4cHJna2p2c3R2aWVqZ290Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMDMyNTAsImV4cCI6MjA4NzU3OTI1MH0.76sndMnRZZNCz0w1nbuxm0Ja_pbHhHmD5hzaM1w4r6M';

const sb = window.supabase.createClient(SB_URL, SB_KEY);

let page = 'dashboard';
let isReg = false;
let projects = [], tasks = [], team = [];

// ============ ELEMENTS ============
const $ = id => document.getElementById(id);

// ============ LOADING ============
function loading(on) { $('loader').classList.toggle('on', on); }

// ============ AUTH ============
$('aBtn').addEventListener('click', doAuth);
$('aTog2').addEventListener('click', toggleMode);
$('iPass').addEventListener('keydown', e => { if(e.key === 'Enter') doAuth(); });
$('iEmail').addEventListener('keydown', e => { if(e.key === 'Enter') doAuth(); });
$('logoutBtn').addEventListener('click', doLogout);
$('togSb').addEventListener('click', () => { $('sb').classList.toggle('mini'); $('mn').classList.toggle('mini'); });
$('mBg').addEventListener('click', e => { if(e.target === $('mBg')) closeModal(); });

function toggleMode() {
  isReg = !isReg;
  $('aTitle').textContent = isReg ? 'إنشاء حساب جديد' : 'تسجيل الدخول';
  $('aSub').textContent = isReg ? 'أنشئ حسابك للبدء' : 'أدخل بياناتك للوصول إلى لوحة التحكم';
  $('aBtn').textContent = isReg ? 'إنشاء الحساب' : 'تسجيل الدخول';
  $('fName').classList.toggle('hide', !isReg);
  $('aTog').innerHTML = isReg ? 'لديك حساب؟ <a id="aTog2">تسجيل الدخول</a>' : 'ليس لديك حساب؟ <a id="aTog2">إنشاء حساب جديد</a>';
  $('aTog2').addEventListener('click', toggleMode);
  hideErr();
}

function showErr(m) { $('aErr').textContent = m; $('aErr').classList.add('show'); }
function hideErr() { $('aErr').classList.remove('show'); }

async function doAuth() {
  hideErr();
  const email = $('iEmail').value.trim();
  const pass = $('iPass').value;

  if (!email || !pass) { showErr('أدخل البريد وكلمة المرور'); return; }
  if (pass.length < 6) { showErr('كلمة المرور 6 أحرف على الأقل'); return; }

  $('aBtn').disabled = true;
  $('aBtn').innerHTML = '<span class="spinner"></span> جارٍ المعالجة...';

  try {
    if (isReg) {
      const nm = $('iName')?.value?.trim() || 'مستخدم';
      const { data, error } = await sb.auth.signUp({
        email, password: pass,
        options: { data: { full_name: nm } }
      });
      if (error) throw error;
      // Try auto-login
      const res2 = await sb.auth.signInWithPassword({ email, password: pass });
      if (res2.error) {
        showErr('تم إنشاء الحساب! تحقق من بريدك ثم سجل الدخول.');
        resetAuthBtn(); return;
      }
      openApp(res2.data.user);
    } else {
      const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
      if (error) throw error;
      openApp(data.user);
    }
  } catch (err) {
    let msg = 'حدث خطأ غير متوقع';
    if (err.message) {
      if (err.message.includes('Invalid login')) msg = 'بيانات الدخول غير صحيحة';
      else if (err.message.includes('Email not confirmed')) msg = 'تحقق من بريدك الإلكتروني أولاً';
      else if (err.message.includes('already registered')) msg = 'البريد مسجل مسبقاً، سجل الدخول';
      else msg = err.message;
    }
    showErr(msg);
    resetAuthBtn();
  }
}

function resetAuthBtn() {
  $('aBtn').disabled = false;
  $('aBtn').textContent = isReg ? 'إنشاء الحساب' : 'تسجيل الدخول';
}

async function doLogout() {
  await sb.auth.signOut();
  $('appPage').style.display = 'none';
  $('loginPage').style.display = 'flex';
  resetAuthBtn();
}

async function openApp(user) {
  const name = user?.user_metadata?.full_name || user?.email?.split('@')[0] || 'مستخدم';
  $('hNm').textContent = name;
  $('hAv').textContent = name.charAt(0);
  $('loginPage').style.display = 'none';
  $('appPage').style.display = 'block';
  buildNav();
  await loadData();
  go('dashboard');
}

// Auto session check
(async () => {
  const { data: { session } } = await sb.auth.getSession();
  if (session?.user) openApp(session.user);
})();

// ============ NAV ============
const NAV = [
  { id:'dashboard', nm:'لوحة التحكم', ic:'<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>' },
  { id:'projects', nm:'المشاريع', ic:'<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M2 20a2 2 0 002 2h16a2 2 0 002-2V8l-7 5V8l-7 5V4a2 2 0 00-2-2H4a2 2 0 00-2 2Z"/></svg>' },
  { id:'tasks', nm:'المهام', ic:'<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 18H3"/><path d="m15 18 2 2 4-4"/><path d="M16 12H3"/><path d="M16 6H3"/></svg>' },
  { id:'team', nm:'فريق العمل', ic:'<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>' },
  { id:'reports', nm:'التقارير', ic:'<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7Z"/><path d="M14 2v4a2 2 0 002 2h4"/></svg>' },
  { id:'calendar', nm:'التقويم', ic:'<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>' },
  { id:'settings', nm:'الإعدادات', ic:'<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12.22 2h-.44a2 2 0 00-2 2v.18a2 2 0 01-1 1.73l-.43.25a2 2 0 01-2 0l-.15-.08a2 2 0 00-2.73.73l-.22.38a2 2 0 00.73 2.73l.15.1a2 2 0 011 1.72v.51a2 2 0 01-1 1.74l-.15.09a2 2 0 00-.73 2.73l.22.38a2 2 0 002.73.73l.15-.08a2 2 0 012 0l.43.25a2 2 0 011 1.73V20a2 2 0 002 2h.44a2 2 0 002-2v-.18a2 2 0 011-1.73l.43-.25a2 2 0 012 0l.15.08a2 2 0 002.73-.73l.22-.39a2 2 0 00-.73-2.73l-.15-.08a2 2 0 01-1-1.74v-.5a2 2 0 011-1.74l.15-.09a2 2 0 00.73-2.73l-.22-.38a2 2 0 00-2.73-.73l-.15.08a2 2 0 01-2 0l-.43-.25a2 2 0 01-1-1.73V4a2 2 0 00-2-2z"/><circle cx="12" cy="12" r="3"/></svg>' },
];

function buildNav() {
  $('sNav').innerHTML = NAV.map(n =>
    `<button class="nv ${n.id===page?'on':''}" data-p="${n.id}">${n.ic}<span>${n.nm}</span>${n.id===page?'<div class="nv-d"></div>':''}</button>`
  ).join('');
  $('sNav').querySelectorAll('.nv').forEach(b => b.addEventListener('click', () => go(b.dataset.p)));
}

function go(p) {
  page = p;
  const t = { dashboard:'لوحة التحكم', projects:'المشاريع', tasks:'المهام', team:'فريق العمل', reports:'التقارير', calendar:'التقويم', settings:'الإعدادات' };
  $('pgT').textContent = t[p];
  buildNav();
  render();
}

// ============ DATA ============
async function loadData() {
  loading(true);
  try {
    const [p, t, m] = await Promise.all([
      sb.from('projects').select('*').order('created_at', { ascending: false }),
      sb.from('tasks').select('*').order('created_at', { ascending: false }),
      sb.from('team_members').select('*').order('created_at', { ascending: false }),
    ]);
    projects = p.data || [];
    tasks = t.data || [];
    team = m.data || [];
  } catch (e) { console.error(e); }
  loading(false);
}

// ============ HELPERS ============
function prg(v) {
  const c = v>=75?'#059669':v>=50?'#0284C7':v>=25?'#F59E0B':'#DC2626';
  return `<div class="prg"><div class="prg-t"><div class="prg-f" style="width:${v}%;background:${c}"></div></div><span class="prg-v" style="color:${c}">${v}%</span></div>`;
}
function badge(s) {
  const m = {'قيد التنفيذ':'act','مكتمل':'ok','متأخر':'err','جديد':'new'};
  return `<span class="bg bg-${m[s]||'new'}"><span class="bg-d"></span>${s}</span>`;
}
function prio(p) {
  return `<span class="pr-${p==='عالي'?'h':p==='منخفض'?'l':'m'}">${p}</span>`;
}
function emp(ic, t, d, btn, act) {
  return `<div class="emp"><div class="emp-i">${ic}</div><div class="emp-t">${t}</div><div class="emp-d">${d}</div>${btn?`<button class="btn btn-p" onclick="${act}">${btn}</button>`:''}</div>`;
}

// ============ RENDER ============
function render() {
  const c = $('pgC');
  const fn = { dashboard:rDash, projects:rProj, tasks:rTask, team:rTeam, reports:rRep, calendar:rCal, settings:rSet };
  c.innerHTML = (fn[page] || rDash)();
}

function rDash() {
  const tp=projects.length, at=tasks.filter(t=>t.status==='قيد التنفيذ').length, ct=tasks.filter(t=>t.status==='مكتمل').length, lp=projects.filter(p=>p.status==='متأخر').length;
  let h = `<div class="g4">
    <div class="st"><div class="st-i" style="background:#DBEAFE"><svg width="20" height="20" fill="none" stroke="#0284C7" stroke-width="2" viewBox="0 0 24 24"><path d="M2 20a2 2 0 002 2h16a2 2 0 002-2V8l-7 5V8l-7 5V4a2 2 0 00-2-2H4a2 2 0 00-2 2Z"/></svg></div><div class="st-v">${tp}</div><div class="st-l">إجمالي المشاريع</div></div>
    <div class="st"><div class="st-i" style="background:#FEF3C7"><svg width="20" height="20" fill="none" stroke="#F59E0B" stroke-width="2" viewBox="0 0 24 24"><path d="M11 18H3"/><path d="m15 18 2 2 4-4"/><path d="M16 12H3"/><path d="M16 6H3"/></svg></div><div class="st-v">${at}</div><div class="st-l">المهام النشطة</div></div>
    <div class="st"><div class="st-i" style="background:#D1FAE5"><svg width="20" height="20" fill="none" stroke="#059669" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg></div><div class="st-v">${ct}</div><div class="st-l">المهام المكتملة</div></div>
    <div class="st"><div class="st-i" style="background:#FEE2E2"><svg width="20" height="20" fill="none" stroke="#DC2626" stroke-width="2" viewBox="0 0 24 24"><path d="m21.73 18-8-14a2 2 0 00-3.48 0l-8 14A2 2 0 004 21h16a2 2 0 001.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg></div><div class="st-v">${lp}</div><div class="st-l">المشاريع المتأخرة</div></div>
  </div>`;
  if (!tp && !tasks.length) {
    h += `<div class="card">${emp('<svg width="36" height="36" fill="none" stroke="#94A3B8" stroke-width="1.5" viewBox="0 0 24 24"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>','مرحباً بك في نظام إدارة المشاريع','ابدأ بإضافة مشروعك الأول','+ مشروع جديد','openAddProject()')}</div>`;
  } else {
    h += '<div class="g2">';
    h += `<div class="card"><div class="card-h"><span class="card-t">إنجاز المشاريع</span></div>${projects.map(p=>`<div style="display:flex;align-items:center;gap:14px;margin-bottom:14px"><span style="font-size:12px;font-weight:600;min-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.name}</span><div style="flex:1">${prg(p.progress||0)}</div></div>`).join('')}</div>`;
    h += `<div class="card"><div class="card-h"><span class="card-t">آخر المهام</span></div>${tasks.slice(0,5).map(t=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:10px;background:#F8FAFC;margin-bottom:8px"><div style="display:flex;align-items:center;gap:10px"><div style="width:28px;height:28px;border-radius:7px;background:${t.status==='مكتمل'?'#D1FAE5':t.status==='متأخر'?'#FEE2E2':'#DBEAFE'};display:flex;align-items:center;justify-content:center"><svg width="14" height="14" fill="none" stroke="${t.status==='مكتمل'?'#059669':t.status==='متأخر'?'#DC2626':'#0284C7'}" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg></div><div><div style="font-size:12px;font-weight:600">${t.title}</div><div style="font-size:10px;color:#94A3B8">${t.project_name||''}</div></div></div>${badge(t.status)}</div>`).join('')}${!tasks.length?'<div style="text-align:center;padding:16px;color:#94A3B8;font-size:12px">لا توجد مهام</div>':''}</div>`;
    h += '</div>';
  }
  return h;
}

function rProj() {
  let h = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><span style="font-size:13px;color:var(--txt2)">إجمالي: <b>${projects.length}</b></span><button class="btn btn-p" onclick="openAddProject()">+ مشروع جديد</button></div>`;
  if (!projects.length) return h + `<div class="card">${emp('<svg width="36" height="36" fill="none" stroke="#94A3B8" stroke-width="1.5" viewBox="0 0 24 24"><path d="M2 20a2 2 0 002 2h16a2 2 0 002-2V8l-7 5V8l-7 5V4a2 2 0 00-2-2H4a2 2 0 00-2 2Z"/></svg>','لا توجد مشاريع','أضف أول مشروع','+ مشروع جديد','openAddProject()')}</div>`;
  return h + `<div class="g3">${projects.map(p=>`<div class="pc"><div style="display:flex;justify-content:space-between;margin-bottom:4px">${badge(p.status)}${prio(p.priority)}</div><h3>${p.name}</h3><div style="font-size:11px;color:#94A3B8;margin-bottom:12px">المدير: ${p.manager||'-'}</div>${prg(p.progress||0)}<div class="pc-m"><div class="pc-mi"><svg width="12" height="12" fill="none" stroke="#94A3B8" stroke-width="2" viewBox="0 0 24 24"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/></svg>${p.end_date||'-'}</div><div class="pc-mi"><svg width="12" height="12" fill="none" stroke="#94A3B8" stroke-width="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>${p.team_count||0} عضو</div></div><button class="btn btn-d" style="margin-top:10px;width:100%" onclick="delProject(${p.id})">حذف المشروع</button></div>`).join('')}</div>`;
}

function rTask() {
  let h = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><span style="font-size:13px;color:var(--txt2)">إجمالي: <b>${tasks.length}</b></span><button class="btn btn-p" onclick="openAddTask()">+ مهمة جديدة</button></div>`;
  if (!tasks.length) return h + `<div class="card">${emp('<svg width="36" height="36" fill="none" stroke="#94A3B8" stroke-width="1.5" viewBox="0 0 24 24"><path d="M11 18H3"/><path d="m15 18 2 2 4-4"/><path d="M16 12H3"/><path d="M16 6H3"/></svg>','لا توجد مهام','أضف أول مهمة','+ مهمة جديدة','openAddTask()')}</div>`;
  return h + `<div class="card" style="padding:0;overflow:hidden"><table class="tb"><thead><tr><th>المهمة</th><th>المشروع</th><th>المسؤول</th><th>الحالة</th><th>الأولوية</th><th>الاستحقاق</th><th></th></tr></thead><tbody>${tasks.map(t=>`<tr><td style="font-weight:600">${t.title}</td><td style="color:var(--txt2)">${t.project_name||'-'}</td><td><span style="display:inline-flex;align-items:center;gap:6px"><span style="width:24px;height:24px;border-radius:6px;background:#DBEAFE;display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#1D4ED8">${(t.assignee||'غ').charAt(0)}</span>${t.assignee||'-'}</span></td><td>${badge(t.status)}</td><td>${prio(t.priority)}</td><td style="color:var(--txt2)">${t.due_date||'-'}</td><td><button class="btn btn-d" onclick="delTask(${t.id})">حذف</button></td></tr>`).join('')}</tbody></table></div>`;
}

function rTeam() {
  let h = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><span style="font-size:13px;color:var(--txt2)">الأعضاء: <b>${team.length}</b></span><button class="btn btn-p" onclick="openAddMember()">+ إضافة عضو</button></div>`;
  if (!team.length) return h + `<div class="card">${emp('<svg width="36" height="36" fill="none" stroke="#94A3B8" stroke-width="1.5" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>','لا يوجد أعضاء','أضف أعضاء فريقك','+ إضافة عضو','openAddMember()')}</div>`;
  return h + `<div class="g3">${team.map(m=>`<div class="tc"><div class="tc-av">${m.name.charAt(0)}</div><div style="font-size:15px;font-weight:700;margin-bottom:3px">${m.name}</div><div style="font-size:12px;color:var(--pri2);font-weight:600;margin-bottom:2px">${m.role||'-'}</div><div style="font-size:11px;color:#94A3B8;margin-bottom:14px">${m.department||'-'}</div><button class="btn btn-d" onclick="delMember(${m.id})">حذف</button></div>`).join('')}</div>`;
}

function rRep() {
  const r=[{t:'تقرير الأداء',d:'ملخص أداء المشاريع',c:'#0284C7'},{t:'تقرير الميزانيات',d:'تحليل المصروفات',c:'#059669'},{t:'تقرير المخاطر',d:'تقييم المخاطر',c:'#DC2626'},{t:'تقرير الموارد',d:'توزيع الموظفين',c:'#7C3AED'},{t:'تقرير الإنجازات',d:'المعالم المحققة',c:'#F59E0B'},{t:'تقرير مخصص',d:'حسب المعايير',c:'#64748B'}];
  return `<div class="g3">${r.map(x=>`<div class="rpc"><div class="rpc-i" style="background:${x.c}12"><svg width="20" height="20" fill="none" stroke="${x.c}" stroke-width="2" viewBox="0 0 24 24"><path d="M15 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7Z"/><path d="M14 2v4a2 2 0 002 2h4"/></svg></div><div style="font-size:14px;font-weight:700;margin-bottom:4px">${x.t}</div><div style="font-size:11px;color:#94A3B8">${x.d}</div></div>`).join('')}</div>`;
}

function rCal() {
  const d=['الأحد','الإثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];
  let c = d.map(x=>`<div class="c-hd">${x}</div>`).join('');
  for(let i=1;i<=28;i++){const t=i===25;c+=`<div class="c-d${t?' tdy':''}"><span class="c-dn${t?' tdy':''}">${i}</span></div>`;}
  return `<div class="card"><div class="card-h"><span class="card-t">فبراير 2026</span></div><div class="cg">${c}</div></div>`;
}

function rSet() {
  return `<div class="g2"><div class="card"><div class="card-t" style="margin-bottom:16px">الملف الشخصي</div><div class="fg"><label>الاسم</label><input class="s-inp" placeholder="الاسم"></div><div class="fg"><label>البريد</label><input class="s-inp" placeholder="email" dir="ltr" style="text-align:left"></div><div class="fg"><label>الوظيفة</label><input class="s-inp" placeholder="المسمى"></div><button class="btn btn-p" style="margin-top:6px">حفظ</button></div><div class="card"><div class="card-t" style="margin-bottom:16px">معلومات النظام</div>${[['الإصدار','v2.0'],['آخر تحديث','2026-02-25']].map(([a,b])=>`<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--brd2)"><span style="font-size:12px;color:var(--txt2)">${a}</span><span style="font-size:12px;font-weight:600">${b}</span></div>`).join('')}</div></div>`;
}

// ============ MODALS ============
function openModal(h) { $('mC').innerHTML = h; $('mBg').classList.add('open'); }
function closeModal() { $('mBg').classList.remove('open'); }

function openAddProject() {
  openModal(`<h3>مشروع جديد</h3>
    <div class="fg"><label>اسم المشروع *</label><input id="pN"></div>
    <div class="fg"><label>مدير المشروع</label><input id="pM"></div>
    <div class="m-row"><div class="fg"><label>الحالة</label><select id="pS"><option>جديد</option><option>قيد التنفيذ</option><option>مكتمل</option><option>متأخر</option></select></div><div class="fg"><label>الأولوية</label><select id="pPr"><option>متوسط</option><option>عالي</option><option>منخفض</option></select></div></div>
    <div class="m-row"><div class="fg"><label>تاريخ البدء</label><input id="pSD" type="date"></div><div class="fg"><label>تاريخ الانتهاء</label><input id="pED" type="date"></div></div>
    <div class="m-row3"><div class="fg"><label>الفريق</label><input id="pT" type="number" value="0"></div><div class="fg"><label>الإنجاز %</label><input id="pPg" type="number" value="0"></div><div class="fg"><label>الميزانية</label><input id="pB" type="number" value="0"></div></div>
    <div class="m-btns"><button class="btn btn-p" onclick="addProject()">إضافة</button><button class="btn-cancel" onclick="closeModal()">إلغاء</button></div>`);
}

async function addProject() {
  const n = $('pN').value.trim();
  if (!n) return alert('أدخل اسم المشروع');
  loading(true); closeModal();
  const { data, error } = await sb.from('projects').insert([{
    name: n, manager: $('pM').value||'', status: $('pS').value, priority: $('pPr').value,
    start_date: $('pSD').value||'', end_date: $('pED').value||'',
    team_count: +$('pT').value||0, progress: +$('pPg').value||0, budget: +$('pB').value||0,
  }]).select();
  if (error) { alert(error.message); loading(false); return; }
  projects.unshift(data[0]);
  loading(false); render();
}

async function delProject(id) {
  if (!confirm('حذف المشروع؟')) return;
  loading(true);
  await sb.from('projects').delete().eq('id', id);
  projects = projects.filter(p => p.id !== id);
  loading(false); render();
}

function openAddTask() {
  const opts = projects.length ? projects.map(p=>`<option value="${p.name}">${p.name}</option>`).join('') : '<option value="">-</option>';
  openModal(`<h3>مهمة جديدة</h3>
    <div class="fg"><label>عنوان المهمة *</label><input id="tT"></div>
    <div class="fg"><label>المشروع</label><select id="tP">${opts}</select></div>
    <div class="fg"><label>المسؤول</label><input id="tA"></div>
    <div class="m-row"><div class="fg"><label>الحالة</label><select id="tS"><option>جديد</option><option>قيد التنفيذ</option><option>مكتمل</option><option>متأخر</option></select></div><div class="fg"><label>الأولوية</label><select id="tPr"><option>متوسط</option><option>عالي</option><option>منخفض</option></select></div></div>
    <div class="fg"><label>تاريخ الاستحقاق</label><input id="tD" type="date"></div>
    <div class="m-btns"><button class="btn btn-p" onclick="addTask()">إضافة</button><button class="btn-cancel" onclick="closeModal()">إلغاء</button></div>`);
}

async function addTask() {
  const t = $('tT').value.trim();
  if (!t) return alert('أدخل عنوان المهمة');
  loading(true); closeModal();
  const { data, error } = await sb.from('tasks').insert([{
    title: t, project_name: $('tP').value||'', assignee: $('tA').value||'',
    status: $('tS').value, priority: $('tPr').value, due_date: $('tD').value||'',
  }]).select();
  if (error) { alert(error.message); loading(false); return; }
  tasks.unshift(data[0]);
  loading(false); render();
}

async function delTask(id) {
  if (!confirm('حذف المهمة؟')) return;
  loading(true);
  await sb.from('tasks').delete().eq('id', id);
  tasks = tasks.filter(t => t.id !== id);
  loading(false); render();
}

function openAddMember() {
  openModal(`<h3>عضو جديد</h3>
    <div class="fg"><label>الاسم *</label><input id="mN"></div>
    <div class="fg"><label>الوظيفة</label><input id="mR"></div>
    <div class="fg"><label>القسم</label><input id="mD"></div>
    <div class="fg"><label>البريد</label><input id="mE" dir="ltr" style="text-align:left"></div>
    <div class="m-btns"><button class="btn btn-p" onclick="addMember()">إضافة</button><button class="btn-cancel" onclick="closeModal()">إلغاء</button></div>`);
}

async function addMember() {
  const n = $('mN').value.trim();
  if (!n) return alert('أدخل الاسم');
  loading(true); closeModal();
  const { data, error } = await sb.from('team_members').insert([{
    name: n, role: $('mR').value||'', department: $('mD').value||'', email: $('mE').value||'',
  }]).select();
  if (error) { alert(error.message); loading(false); return; }
  team.unshift(data[0]);
  loading(false); render();
}

async function delMember(id) {
  if (!confirm('حذف العضو؟')) return;
  loading(true);
  await sb.from('team_members').delete().eq('id', id);
  team = team.filter(m => m.id !== id);
  loading(false); render();
}
</script>
</body>
</html>
